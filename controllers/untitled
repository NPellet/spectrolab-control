

var events = require("events");
var logger = require("../app/logger");
var util = require("util");

var InstrumentController = function() {};

util.inherits( InstrumentController, events.EventEmitter );

VXI11InstrumentController.prototype.log = function( message ) {
	logger.log( message );
}


VXI11InstrumentController.prototype.query = function( queueElement ) {

	return new Promise( function( resolver, rejecter ) {

		if( ! instrument.shellInstance ) {
			throw "Instrument has no python shell associated";
		}

		var query = queueElement.command;
		var ask = query.indexOf('?') > -1;

		if( ask ) {

			function listen( prevData ) {

				module.shellInstance.once( 'message', function( data ) {


		            data = prevData + data.toString('ascii');
		            data = data.replace("\n", "");

		            if( data.indexOf( "ERROR" ) > -1 ) {
		              rejecter( data );
		            } else {
		              resolver( data );
		            }



				} );
			}

			listen("");
			instrument.shellInstance.send( query );

		} else {

			instrument.shellInstance.send( query );
			resolver();
		}

	} );
}


VXI11InstrumentController.prototype.connect = function( ) {

	var instrument = this;

	if( module.connecting ) {
		return module.connecting;
	}

	var promise = new Promise( function( resolver, rejecter ) {

		// Already connected => Return ok
		if( module.connected ) {
			resolver();
			return;
		}

		instrument.log( "Trying to connect to " + instrument.getName() + "  on host " + module.params.host + " via VXI11" );

		try {

			// Launches a python instance which will communicate in VXI11 with the scope
			instrument.shellInstance = new pythonShell( 'iovxi.py', {
				scriptPath: path.resolve( 'app/util/vxi11/' ),
				args: [ instrument.params.host ], // Pass the IP address
				mode: "text" // Text mode
			} );

			// At this point we are already connected. No asynchronous behaviour with python
			instrument.shellInstance.once( 'message', function( data ) {

				if( data == "IO:connected" ) {

					instrument.connecting = false;
					instrument.connected = true;

					instrument.logOk("Connected to " + instrument.getName() + "  on host " + module.params.host + " via VXI11" );
					resolver( module );
					instrument.emit("connected");

				} else {
			//		rejecter( module );
					instrument.emit("connectionerror");
					instrument.connected = false;
					instrument.logError("Unexpected response from " + instrument.getName() + " during connection. Response was : " + data );
				}
			});

			instrument.shellInstance.on( 'error', function( error ) {

		//		rejecter( module );
				instrument.emit("connectionerror");
				instrument.connected = false;
				instrument.logError("Error while connecting to " + instrument.getName() + " . Check connection and cables. You may have to reboot it. Error was: " + error );
			});

			instrument.shellInstance.on( 'message', function( data ) {
				console.log("Receiving from AFG: " + data );
			});

		} catch( e ) {
			instrument.emit("connectionerror");
			instrument.logError("Cannot reach " + instrument.getName() + " . Check connection and cables. You may have to reboot it");
	//		rejecter();
		}
	} );

	if( ! instrument.connected ) {
		instrument.connecting = promise;
	}

	return promise;

}




module.exports = VXI11InstrumentController;
